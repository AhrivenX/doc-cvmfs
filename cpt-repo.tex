\chapter{Creating a Repository}
\label{sct:createrepo}

Though in principle a \cvmfs\ repository is just a directory tree, it is converted into a \newterm{repository} format first.
The repository format is in particular content addressable storage.
We call the original directory tree \newterm{shadow tree}.
This task includes creating the file catalog(s), compressing the files and calculating content hashes.
Furthermore, we store the files in the same layout as the local \cvmfs\ cache on the server, \ie\ as SHA1 data chunks.
We do so to exploit redundancy and in order to mangle the real file name into an SHA1 key when \cvmfs\ downloads files.
This circumvents certain firewall restrictions.
For instance, many firewalls block an HTTP request to a file called \texttt{root.exe}.
Figure~\ref{fig:installwebserver} outlines the repository generation.

\begin{figure}
	\begin{center}
		\input{figures/install.tex}
	\end{center}
	\caption{Converting a shadow tree into a repository. The file catalog contains the directory structure as well as file metadata, symbolic links, and secure hash keys of regular files. Regular files are compressed and renamed to their cryptographic content hash before copied into the data store.}
	\label{fig:installwebserver}
\end{figure}


Since the repositories may contain many file system objects\footnote{For ATLAS, for example, ``many'' means order of $10^7$ file system objects (\ie number of regular files, symbolic links, and directories).}, we cannot afford to process an entire shadow tree from scratch for every update.
Instead, we choose a journal based approach supported by the \redirfs\ kernel level framework~\cite{redirfs05}.
The \redirfs\ framework hooks into VFS\footnote{Virtual File System Switch, an operating system abstraction layer for file systems.} calls and allows to install so-called filters.
By installing a \cvmfs\ filter for \redirfs, we create a journal of file system changes which is processed by \texttt{cvmfs\_sync}.
``Process the journal'' means that the shadow tree is synchronized with the repository.
This includes compression of new and updated files and updating of the file catalogs.

\begin{table}
	\begin{tabularx}{\linewidth}{lX}
		\lstinline{/shadow} & This is a standard directory which will be watched by {\scshape inotify}. This directory will be seen by \cvmfs\ clients as read-only directory.  Install your software in here.\\
		\lstinline{/pub} & Conatins everything that needs to be served by the webserver. \\
		\lstinline{/pub/catalogs} & Contains the cvmfs catalogs and symlinks to \lstinline{/pub/data}.  Mimics the directory structure in \lstinline{/shadow} as far as necessary to provide all the entry points for catalogs.  For Apache servers, it is recommended to add a \lstinline{.htaccess} file in this directory allowing symlinks to be followed. \\
		\lstinline{/pub/data} & The SHA1 data cache, looks like the cache directory on clients except that files reside in a compressed form.\\
		\lstinline{/ctrl} & Contains zipped versions of old journals and may contain additional control files for \texttt{cvmfs\_sync}. \\
	\end{tabularx}
	\caption{Recommended directory layout of a repository.  These directories don't have to be in the root directory.  The \texttt{shadow}, the \texttt{ctrl}, and the \texttt{pub} directory don't have to be in the same parent directory.}
	\label{tab:journaldirs}
\end{table}

In order to create a repository, the server part of \cvmfs\ and the \cvmfs\ kernel modules are required.
The server part and the kernel modules are available as rpms (see Section~\ref{apx:rpms}).
The server tools contain the \texttt{cvmfs\_sync} and the \texttt{cvmfs\_zpipe}, \texttt{cvmfs\_sign}, \texttt{cvmfs\_pull}, \texttt{cvmfs\_scrum}, and \texttt{cvmfs\_clgcmp} tools as well as the \texttt{redirfs} and \texttt{cvmfsflt} kernel modules.
Create the directory structure shown in Table~\ref{tab:journaldirs}.
The directory and file names are mostly recommandations and fit to the example command line to start the \cvmfs\ server daemon, which is part of the \cvmfs\ \texttt{add-ons} directory.

From the point of view of the file system, repositories are relocatable.
However, many software installation tools hard-code the full path.
In effect, repositories have to be mounted at the same location that was used to install it on the release manager machine.
By convention, \cvmfs\ repositories are mounted using  fully qualified repository name under \texttt{/cvmfs}, for instance at \texttt{/cvmfs/atlas.cern.ch}.

Typically a repository publisher does the following steps in order to create or update a repository:
\begin{enumerate}
	\item Make the necessary changes to the shadow directory, \ie add new directories, patch certain binaries, \dots
	\item Test the software installation
	\item Run the \texttt{cvmfs\_sync} utility and optionally the \texttt{cvmfs\_sign} utility.
	\item Make the web server serve the new version of the pub directory.
\end{enumerate}

\section{CernVM-FS Respository Out of the Box}
Small organizations can use the \texttt{cvmfs\_server} script in order to easily create a new \cvmfs\ repository with reasonable defaults.
Run without options for documentation.
The tool expects an SL5 distribution with an \texttt{httpd} service running and \emph{no} \cvmfs\ client utilities.
The server utilities and the client utilites are mutually exclusive.

The \texttt{cvmfs\_server} uses the /srv/cvmfs area as storage. 
So if you want to use a large hard disk, mount it there upfront.

The necessary steps for a new repository are:
\begin{enumerate}
	\item \texttt{cvmfs\_server mkfs ams.iss.xz}
	\item Install software in /cvmfs/ams.iss.xz as user cvmfs
	\item \texttt{cvmfs\_server publish}
	\item Every 30 days: \texttt{cvmfs\_server resign}
\end{enumerate}

Note that the software signing key and the release manager machine certificate are newly created as well.
In particular, they are different from CERN repositories.
In order to mount the so-created repositories on \cvmfs\ clients, push the public signing key /etc/cvmfs/keys/ams.iss.xz.pub from the release manager machine to the clients.
A release manager machine can only manage one repository.


